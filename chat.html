<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexusVL - Deep Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon: #00f2ff;
            --neon-pink: #ff0055;
            --bg: #020205;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Rajdhani'; 
            overflow: hidden; 
            height: 100vh;
        }

        /* --- BACKGROUND: CIDADE COM JANELAS --- */
        #city-viewport {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            transition: 2s ease-in-out;
        }

        .city-svg { width: 100%; height: 100%; fill: none; }
        .building { stroke: rgba(0, 242, 255, 0.2); stroke-width: 0.5; pointer-events: none; }
        
        .window { 
            fill: rgba(0, 242, 255, 0.05); 
            cursor: pointer; 
            pointer-events: all;
            transition: 0.3s;
        }
        .window:hover { fill: var(--neon); filter: drop-shadow(0 0 5px var(--neon)); }
        
        /* Ciclo Dia/Noite */
        .day-mode .building { stroke: rgba(255, 174, 0, 0.3); }
        .day-mode .window:hover { fill: #ffae00; }
        .day-mode { background: radial-gradient(circle at top, #1a1a2e, #020205); }

        /* --- INTERFACE DE CHAT --- */
        .chat-overlay {
            position: relative;
            z-index: 10;
            display: grid;
            grid-template-columns: 80px 1fr;
            height: 100vh;
            padding-top: 75px;
            background: linear-gradient(to right, rgba(0,0,0,0.9), transparent);
            pointer-events: none; /* Deixa clicar nas janelas ao fundo */
        }

        .chat-menu, .chat-content { pointer-events: all; }

        .chat-menu {
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px 0;
            backdrop-filter: blur(5px);
        }

        .menu-item {
            width: 50px; height: 50px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
            cursor: pointer; transition: 0.3s;
            font-size: 1.2rem;
            border: 1px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--neon);
            box-shadow: 0 0 15px var(--neon);
        }

        .chat-content {
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            mask-image: linear-gradient(transparent, black 10%, black 90%, transparent);
        }

        .message {
            background: rgba(0,0,0,0.4);
            border-left: 2px solid var(--neon);
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            backdrop-filter: blur(5px);
        }

        .friend-list-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; background: rgba(255,255,255,0.02);
            border-radius: 8px; margin-bottom: 5px;
        }

        .chat-input-area {
            display: flex; gap: 10px;
            background: rgba(0,0,0,0.8);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        input {
            flex: 1; background: transparent; border: none; color: #fff;
            font-family: 'Rajdhani'; outline: none;
        }

        .online-counter {
            position: fixed; bottom: 20px; left: 100px;
            font-family: 'Orbitron'; font-size: 0.6rem;
            color: var(--neon); z-index: 100;
        }
    </style>
</head>
<body id="main-body">

    <div id="city-viewport">
        <svg id="city-svg" class="city-svg" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMax slice">
            <defs>
                <filter id="glow"><feGaussianBlur stdDeviation="1.5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            </defs>
            <g id="celestial-body"></g>
            <g id="buildings-layer"></g>
        </svg>
    </div>

    <div class="chat-overlay">
        <nav class="chat-menu">
            <div class="menu-item active" id="btn-global" onclick="switchChat('global')">üåê</div>
            <div class="menu-item" id="btn-friends" onclick="switchChat('friends')">üë•</div>
            <div class="menu-item" title="Add Amigo" onclick="promptAddFriend()">‚ûï</div>
        </nav>

        <main class="chat-content">
            <h2 id="chat-title" style="font-family: 'Orbitron'; font-size: 0.7rem; margin-bottom: 15px; color: var(--neon); letter-spacing: 2px;">GLOBAL_STREAM</h2>
            <div class="chat-messages" id="chat-box"></div>

            <div class="chat-input-area">
                <input type="text" placeholder="ENTRAR COMANDO..." id="chat-input">
                <button onclick="sendMessage()" style="background:none; border:none; color:var(--neon); font-family:'Orbitron'; font-size:0.6rem; cursor:pointer;">SEND</button>
            </div>
        </main>
    </div>

    <div class="online-counter">
        <span id="online-val">000</span> NODES_ACTIVE
    </div>

    <script type="module">
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const db = getFirestore();
        const auth = getAuth();
        let currentUser = null;

        // --- GERADOR DE CIDADE E JANELAS ---
        function generateCity() {
            const layer = document.getElementById('buildings-layer');
            const celestial = document.getElementById('celestial-body');
            const isDay = new Date().getHours() >= 6 && new Date().getHours() < 18;

            if(isDay) document.getElementById('main-body').classList.add('day-mode');
            celestial.innerHTML = `<circle cx="850" cy="100" r="35" stroke="${isDay ? '#ffae00' : '#00f2ff'}" filter="url(#glow)" />`;

            for(let i = 0; i < 25; i++) {
                const w = 50 + Math.random() * 70;
                const h = 150 + Math.random() * 300;
                const x = i * 45;
                const y = 500 - h;

                // Desenha Pr√©dio
                const b = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                b.setAttribute("x", x); b.setAttribute("y", y); b.setAttribute("width", w); b.setAttribute("height", h);
                b.setAttribute("class", "building");
                layer.appendChild(b);

                // Desenha Janelas Clic√°veis
                for(let row = 1; row < h/20; row++) {
                    for(let col = 1; col < w/15; col++) {
                        if(Math.random() > 0.4) {
                            const win = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                            win.setAttribute("x", x + (col * 12));
                            win.setAttribute("y", y + (row * 18));
                            win.setAttribute("width", 6); win.setAttribute("height", 8);
                            win.setAttribute("class", "window");
                            win.onclick = () => alert("SISTEMA: Segredo encontrado em Node-" + Math.floor(Math.random()*999));
                            layer.appendChild(win);
                        }
                    }
                }
            }
        }

        // --- L√ìGICA DE AMIGOS ---
        window.promptAddFriend = async () => {
            const friendId = prompt("INSIRA O ID DO USU√ÅRIO:");
            if(friendId && currentUser) {
                const friendRef = doc(db, "usuarios", friendId);
                const snap = await getDoc(friendRef);
                if(snap.exists()) {
                    await updateDoc(doc(db, "usuarios", currentUser.uid), {
                        amigos: arrayUnion(friendId)
                    });
                    alert("CONEX√ÉO ESTABELECIDA.");
                } else { alert("USU√ÅRIO N√ÉO ENCONTRADO."); }
            }
        };

        window.switchChat = (type) => {
            const box = document.getElementById('chat-box');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            box.innerHTML = "";
            
            if(type === 'global') {
                document.getElementById('btn-global').classList.add('active');
                document.getElementById('chat-title').innerText = "GLOBAL_STREAM";
                // Aqui entraria o onSnapshot das mensagens globais
            } else {
                document.getElementById('btn-friends').classList.add('active');
                document.getElementById('chat-title').innerText = "PRIVATE_NODES";
                loadFriends();
            }
        };

        async function loadFriends() {
            if(!currentUser) return;
            onSnapshot(doc(db, "usuarios", currentUser.uid), (snap) => {
                const data = snap.data();
                const box = document.getElementById('chat-box');
                if(document.getElementById('chat-title').innerText === "PRIVATE_NODES") {
                    box.innerHTML = "<p style='font-size:0.6rem; color:#444; margin-bottom:10px;'>AMIGOS CONECTADOS:</p>";
                    (data.amigos || []).forEach(async fId => {
                        const fSnap = await getDoc(doc(db, "usuarios", fId));
                        const fData = fSnap.data();
                        box.innerHTML += `<div class="friend-list-item"><span>${fData.avatarEmoji || 'üë§'}</span> <b>${fData.nome}</b></div>`;
                    });
                }
            });
        }

        onAuthStateChanged(auth, user => { 
            if(user) { currentUser = user; generateCity(); } 
            else { window.location.href = "login.html"; }
        });

    </script>
    <script type="module" src="nexus-overlay.js"></script>
</body>
</html>
