<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Habitat | Live Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent-color: #00f2ff; /* Padrão */
            --gold: #ffcc00; 
        }
        body { background: #000; color: #fff; font-family: 'Rajdhani'; margin: 0; overflow-x: hidden; }

        /* HEADER */
        .habitat-header { padding: 40px 20px 20px; text-align: center; }
        .user-rank { font-family: 'Orbitron'; font-size: 0.7rem; color: var(--gold); letter-spacing: 3px; }
        .user-name { font-family: 'Orbitron'; font-size: 1.8rem; margin: 10px 0; text-shadow: 0 0 15px var(--accent-color); }

        /* MUNDO VISUAL */
        .world-container {
            position: relative; height: 500px; width: 100%;
            display: flex; align-items: flex-end; justify-content: center;
            perspective: 1200px; background: radial-gradient(circle at bottom, #0a141a 0%, #000 85%);
            gap: 15px; padding-bottom: 20px;
        }

        .grid-floor {
            position: absolute; bottom: 0; width: 200%; height: 150px;
            background-image: linear-gradient(var(--accent-color) 1px, transparent 1px), linear-gradient(90deg, var(--accent-color) 1px, transparent 1px);
            background-size: 50px 50px; opacity: 0.05; transform: rotateX(70deg);
        }

        /* CUBO E PRÉDIOS */
        .identity-cube {
            width: 90px; height: 90px; z-index: 10; margin-bottom: 60px;
            background: var(--accent-color); box-shadow: 0 0 60px var(--accent-color);
            border-radius: 20px; animation: float 4s ease-in-out infinite;
        }

        .building-asset {
            width: 150px; background: linear-gradient(to top, #050505, #151515);
            border: 2px solid #222; border-bottom: none; display: flex; flex-wrap: wrap;
            padding: 12px; gap: 6px; transition: 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .window { width: 14px; height: 14px; background: #111; border-radius: 2px; transition: 0.5s; }
        .active-win { background: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }

        /* PAINEL DE CUSTOMIZAÇÃO */
        .custom-panel {
            background: rgba(10,10,10,0.9); padding: 20px; margin: 20px;
            border-radius: 20px; border: 1px solid #1a1a1a; text-align: center;
        }
        .color-options { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .color-dot { 
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer; 
            border: 3px solid transparent; transition: 0.3s;
        }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.selected { border-color: #fff; }

        .btn-buy-color {
            margin-top: 15px; background: var(--gold); color: #000; border: none;
            padding: 8px 20px; font-family: 'Orbitron'; font-weight: bold;
            border-radius: 5px; cursor: pointer; font-size: 0.7rem;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(10deg); }
            50% { transform: translateY(-35px) rotate(-10deg); }
        }
    </style>
</head>
<body>

    <script type="module" src="nexus-overlay.js"></script>

    <div class="habitat-header">
        <div class="user-rank" id="display-rank">SYNCING PROTOCOL...</div>
        <div class="user-name" id="display-name">---</div>
    </div>

    <div class="world-container">
        <div class="grid-floor" id="floor"></div>
        
        <div id="user-cube" class="identity-cube"></div>
        
        <div id="user-building" class="building-asset" style="height: 120px;"></div>

        <div id="commerce-building" class="building-asset" style="display: none; border-color: var(--gold); width: 130px;">
            <div style="color:var(--gold); font-family:Orbitron; font-size:0.5rem; width:100%; text-align:center;">OFFICIAL STORE</div>
        </div>
    </div>

    <div class="custom-panel" id="custom-ui" style="display:none;">
        <span class="user-rank" style="color:#aaa;">Customizar Ambiente (500 NP)</span>
        <div class="color-options">
            <div class="color-dot" style="background:#00f2ff;" onclick="previewColor('#00f2ff')"></div>
            <div class="color-dot" style="background:#ff0055;" onclick="previewColor('#ff0055')"></div>
            <div class="color-dot" style="background:#bd00ff;" onclick="previewColor('#bd00ff')"></div>
            <div class="color-dot" style="background:#00ff88;" onclick="previewColor('#00ff88')"></div>
        </div>
        <button class="btn-buy-color" id="btn-save-color">APLICAR MODIFICAÇÃO</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8", 
            authDomain: "minharifadigital.firebaseapp.com", 
            projectId: "minharifadigital", 
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const targetUserID = urlParams.get('id');
        let selectedColor = "#00f2ff";

        // Sincronização em Tempo Real
        if (targetUserID) {
            onSnapshot(doc(db, "usuarios", targetUserID), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    renderHabitat(data);
                    
                    // Só mostra painel de customização se o dono for o usuário logado
                    onAuthStateChanged(auth, user => {
                        if(user && user.uid === targetUserID) {
                            document.getElementById('custom-ui').style.display = 'block';
                        }
                    });
                }
            });
        }

        window.previewColor = (color) => {
            selectedColor = color;
            document.documentElement.style.setProperty('--accent-color', color);
        };

        function renderHabitat(data) {
            const level = Math.floor((data.xp || 0) / 1000) + 1;
            document.getElementById('display-name').innerText = (data.nome || "USER").toUpperCase();
            document.getElementById('display-rank').innerText = `HABITAT LEVEL ${level}`;

            // Aplica cor salva no banco (se existir)
            const userTheme = data.habitatColor || (data.genero === 'F' ? '#ff0055' : '#00f2ff');
            previewColor(userTheme);

            // Prédio
            const building = document.getElementById('user-building');
            const height = 120 + (level * 25);
            building.style.height = height + "px";
            
            building.innerHTML = "";
            for(let i=0; i < (level * 4); i++) {
                const w = document.createElement('div');
                w.className = "window active-win";
                building.appendChild(w);
            }

            // Comércio
            if(data.temComercio) {
                const comm = document.getElementById('commerce-building');
                comm.style.display = "flex";
                comm.style.height = (height * 0.8) + "px";
            }
        }

        // Salvar Nova Cor (Gasta 500 NP)
        document.getElementById('btn-save-color').onclick = async () => {
            const user = auth.currentUser;
            if(!user) return;

            if(confirm("Deseja aplicar esta nova skin por 500 NP (R$ 5,00)?")) {
                const userRef = doc(db, "usuarios", user.uid);
                // Verifica saldo antes (Ideal fazer via Rules, mas aqui vai a lógica JS)
                await updateDoc(userRef, {
                    habitatColor: selectedColor,
                    saldo: increment(-500)
                });
                alert("Protocolo de Skin Aplicado!");
            }
        };
    </script>
</body>
</html>
