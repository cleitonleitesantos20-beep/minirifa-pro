<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Habitat | Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent-color: #555; 
            --gold: #ffcc00; 
            --identity-color: #555;
            --bg-card: rgba(10, 10, 10, 0.98);
        }
        body { background: #000; color: #fff; font-family: 'Rajdhani'; margin: 0; overflow-x: hidden; padding-bottom: 80px; }

        /* NAV */
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 15px; position: absolute; width: 100%; box-sizing: border-box; z-index: 100; gap: 10px; }
        .nav-group { display: flex; gap: 8px; }
        .btn-nav { background: rgba(255,255,255,0.05); border: 1px solid #222; color: #fff; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.6rem; font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; }
        .btn-nav:hover { background: var(--accent-color); border-color: #fff; }

        /* HEADER */
        .habitat-header { padding: 80px 20px 10px; text-align: center; }
        .user-name { font-family: 'Orbitron'; font-size: 1.3rem; margin: 5px 0; text-shadow: 0 0 10px var(--accent-color); }
        .geo-tag { font-size: 0.7rem; color: #888; letter-spacing: 1px; margin-bottom: 10px; text-transform: uppercase; }
        
        .status-badge { 
            display: inline-block; padding: 4px 12px; border: 1px solid var(--accent-color);
            border-radius: 20px; font-size: 0.6rem; color: var(--accent-color); 
            letter-spacing: 2px; text-transform: uppercase; transition: 0.3s;
        }

        /* WORLD - Ajustado para centralizar */
        .world-view {
            position: relative; height: 320px; width: 100%;
            display: flex; align-items: flex-end; justify-content: center;
            perspective: 1000px; background: radial-gradient(circle at bottom, #0a1015 0%, #000 75%);
            gap: 20px; padding-bottom: 20px;
        }
        .identity-cube {
            width: 55px; height: 55px; z-index: 10; margin-bottom: 25px;
            background: var(--identity-color); box-shadow: 0 0 35px var(--identity-color);
            border-radius: 10px; animation: float 4s ease-in-out infinite;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }

        .building-asset {
            width: 90px; background: #080808; 
            border: 2px solid var(--accent-color); 
            border-bottom: none; display: flex; flex-wrap: wrap; padding: 10px; gap: 5px; 
            box-shadow: inset 0 0 15px #000, 0 0 15px var(--accent-color); 
            transition: 0.8s; cursor: pointer; position: relative;
            justify-content: center; align-content: flex-start;
        }
        
        .building-door {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 20px; height: 25px; background: #111;
            border: 1px solid var(--accent-color); border-bottom: none;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .window { width: 9px; height: 9px; background: #111; border-radius: 1px; }
        .active-win { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }

        /* FOOTER ACTION */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px;
            background: linear-gradient(transparent, #000 70%);
            display: flex; justify-content: center; z-index: 150;
        }
        .btn-assets {
            background: #fff; color: #000; border: none; padding: 14px 40px;
            border-radius: 50px; font-family: 'Orbitron'; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); cursor: pointer;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    </style>
</head>
<body>

    <script type="module" src="nexus-overlay.js"></script>

    <nav class="top-nav">
        <div class="nav-group">
            <a href="index.html" class="btn-nav">VOLTAR</a>
            <a href="mapa.html" class="btn-nav">MUNDO</a>
        </div>
        <div id="user-balance" style="color:var(--gold); font-family:Orbitron; font-size:0.7rem;">0.00 NP</div>
    </nav>

    <div class="habitat-header">
        <div class="geo-tag"><span id="display-city">CARREGANDO</span> / <span id="display-state">...</span></div>
        <div class="status-badge" id="display-role">...</div>
        <div class="user-name" id="display-name">---</div>
    </div>

    <div class="world-view">
        <div id="user-cube" class="identity-cube"></div>
        <div id="user-building" class="building-asset"></div>
    </div>

    <div class="info-container" style="padding: 20px; background: var(--bg-card); border-top: 1px solid #111;">
        <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div class="info-item" style="background: #0a0a0a; padding: 10px; border: 1px solid #1a1a1a; border-radius: 8px; text-align: center;">
                <span style="font-size: 0.5rem; color: #555; font-family: 'Orbitron'; display: block;">NEXUS ID</span>
                <span id="info-id" style="font-size: 0.8rem; color: #eee; font-family: 'Orbitron';">#0000</span>
            </div>
            <div class="info-item" style="background: #0a0a0a; padding: 10px; border: 1px solid #1a1a1a; border-radius: 8px; text-align: center;">
                <span style="font-size: 0.5rem; color: #555; font-family: 'Orbitron'; display: block;">LEVEL</span>
                <span id="info-lvl" style="font-size: 0.8rem; color: #eee; font-family: 'Orbitron';">1</span>
            </div>
            <div class="info-item" style="background: #0a0a0a; padding: 10px; border: 1px solid #1a1a1a; border-radius: 8px; text-align: center;">
                <span style="font-size: 0.5rem; color: #555; font-family: 'Orbitron'; display: block;">XP</span>
                <span id="info-xp" style="font-size: 0.8rem; color: #eee; font-family: 'Orbitron';">0</span>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button class="btn-assets" id="btn-view-assets">VISUALIZAR ATIVOS</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8", authDomain: "minharifadigital.firebaseapp.com", projectId: "minharifadigital", appId: "1:59630725905:web:396c8cfca385dc3d957ab0" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const targetID = urlParams.get('id');

        const roles = {
            citizen: { label: "CIDADÃO", color: "#555" },
            tech: { label: "ELETRÔNICOS", color: "#00ff88" },
            clothes: { label: "MODA", color: "#00f2ff" }
            // Adicione os outros conforme necessário
        };

        // Carregar Dados
        onAuthStateChanged(auth, user => {
            const uid = targetID || (user ? user.uid : null);
            if (uid) {
                onSnapshot(doc(db, "usuarios", uid), (snap) => {
                    if (snap.exists()) updateHabitat(snap.data(), uid);
                });
            }
        });

        function updateHabitat(data, uid) {
            const currentRole = data.role || 'citizen';
            const config = roles[currentRole] || roles.citizen;
            
            // Cores e Textos
            document.documentElement.style.setProperty('--accent-color', config.color);
            document.documentElement.style.setProperty('--identity-color', data.userNeonColor || config.color);
            
            document.getElementById('display-name').innerText = (data.nome || "NEXUS").toUpperCase();
            document.getElementById('display-city').innerText = (data.cidade || "NÃO INFORMADA").toUpperCase();
            document.getElementById('display-state').innerText = (data.estado || "---").toUpperCase();
            document.getElementById('display-role').innerText = config.label;
            document.getElementById('user-balance').innerText = `${(data.saldo || 0).toFixed(2)} NP`;
            document.getElementById('info-id').innerText = `#${uid.substring(0, 5).toUpperCase()}`;
            document.getElementById('info-xp').innerText = data.xp || 0;

            const level = Math.floor((data.xp || 0) / 1000) + 1;
            document.getElementById('info-lvl').innerText = level;

            // Construir Prédio dinamicamente
            const b = document.getElementById('user-building');
            b.style.height = (70 + (level * 15)) + "px";
            b.innerHTML = '<div class="building-door"></div>'; 
            
            const numWindows = Math.min(level * 3, 24); // Limite para não quebrar o layout
            for(let i=0; i < numWindows; i++){
                const w = document.createElement('div');
                w.className = "window active-win";
                b.appendChild(w);
            }
        }

        document.getElementById('btn-view-assets').onclick = () => {
            const idToView = targetID || (auth.currentUser ? auth.currentUser.uid : "");
            window.location.href = `ativos.html?id=${idToView}`;
        };
    </script>
</body>
</html>
