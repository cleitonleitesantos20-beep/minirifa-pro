<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Habitat | Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent-color: #555; 
            --gold: #ffcc00; 
            --identity-color: #555;
            --bg-card: rgba(10, 10, 10, 0.98);
        }
        body { background: #000; color: #fff; font-family: 'Rajdhani'; margin: 0; overflow-x: hidden; }

        /* NAV */
        .top-nav { display: flex; justify-content: space-between; padding: 15px; position: absolute; width: 100%; box-sizing: border-box; z-index: 100; }
        .btn-back { background: rgba(255,255,255,0.05); border: 1px solid #222; color: #fff; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.7rem; font-family: 'Orbitron'; }

        /* HEADER */
        .habitat-header { padding: 60px 20px 10px; text-align: center; }
        .user-name { font-family: 'Orbitron'; font-size: 1.3rem; margin: 5px 0; text-shadow: 0 0 10px var(--accent-color); }
        .geo-tag { font-size: 0.7rem; color: #888; letter-spacing: 1px; margin-bottom: 10px; text-transform: uppercase; }
        
        .status-badge { 
            display: inline-block; padding: 4px 12px; border: 1px solid var(--accent-color);
            border-radius: 20px; font-size: 0.6rem; color: var(--accent-color); 
            letter-spacing: 2px; text-transform: uppercase; transition: 0.3s;
        }

        /* WORLD */
        .world-view {
            position: relative; height: 320px; width: 100%;
            display: flex; align-items: flex-end; justify-content: center;
            perspective: 1000px; background: radial-gradient(circle at bottom, #0a1015 0%, #000 75%);
            gap: 12px; padding-bottom: 20px;
        }
        .identity-cube {
            width: 55px; height: 55px; z-index: 10; margin-bottom: 25px;
            background: var(--identity-color); box-shadow: 0 0 35px var(--identity-color);
            border-radius: 10px; animation: float 4s ease-in-out infinite;
        }
        .rainbow-mode {
            background: linear-gradient(45deg, #ff0000, #ff00ff, #0000ff, #00ffff, #00ff00, #ffff00, #ff0000);
            background-size: 400% 400%;
            animation: float 4s ease-in-out infinite, rainbow-shift 8s linear infinite !important;
            box-shadow: 0 0 35px rgba(255,255,255,0.3);
        }

        .building-asset {
            width: 90px; background: #080808; 
            border: 2px solid var(--accent-color); /* Contorno da cor do nicho */
            border-bottom: none; display: flex; flex-wrap: wrap; padding: 8px; gap: 4px; 
            box-shadow: inset 0 0 15px #000, 0 0 15px var(--accent-color); 
            transition: 0.8s; cursor: pointer; position: relative;
        }
        /* Portinha do Prédio */
        .building-door {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 20px; height: 25px; background: #111;
            border: 1px solid var(--accent-color); border-bottom: none;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .window { width: 9px; height: 9px; background: #111; border-radius: 1px; }
        .active-win { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }

        /* INFO BOX */
        .info-container { padding: 20px; background: var(--bg-card); border-top: 1px solid #111; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .info-item { background: #0a0a0a; padding: 10px; border: 1px solid #1a1a1a; border-radius: 8px; text-align: center; }
        .info-label { font-size: 0.5rem; color: #555; font-family: 'Orbitron'; display: block; margin-bottom: 4px; }
        .info-val { font-size: 0.8rem; color: #eee; font-family: 'Orbitron'; }

        /* MODAL */
        .niche-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center;
        }
        .modal-content { background: #0a0a0a; border: 1px solid #222; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .selector-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; margin-bottom: 15px; }
        .opt-btn { background: #111; border: 1px solid #333; color: #fff; padding: 10px 4px; border-radius: 6px; cursor: pointer; font-size: 0.55rem; font-family: 'Orbitron'; text-align: center; }
        
        input, select { 
            width: 100%; background: #111; border: 1px solid #333; color: #fff; 
            padding: 10px; margin: 5px 0; border-radius: 5px; font-family: 'Rajdhani'; box-sizing: border-box;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes rainbow-shift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    </style>
</head>
<body>

    <script type="module" src="nexus-overlay.js"></script>

    <nav class="top-nav">
        <a href="index.html" class="btn-back"> VOLTAR</a>
        <div id="user-balance" style="color:var(--gold); font-family:Orbitron; font-size:0.7rem;">0.00 NP</div>
    </nav>

    <div class="habitat-header">
        <div class="geo-tag"><span id="display-city">CIDADE</span> / <span id="display-state">ESTADO</span></div>
        <div class="status-badge" id="display-role" onclick="toggleNicheMenu()">CARREGANDO...</div>
        <div class="user-name" id="display-name">---</div>
    </div>

    <div class="world-view">
        <div id="user-cube" class="identity-cube"></div>
        <div id="user-building" class="building-asset" onclick="redirectStore()"></div>
    </div>

    <div class="info-container">
        <div class="info-grid">
            <div class="info-item"><span class="info-label">NEXUS ID</span><span class="info-val" id="info-id">#0000</span></div>
            <div class="info-item"><span class="info-label">LEVEL</span><span class="info-val" id="info-lvl">1</span></div>
            <div class="info-item"><span class="info-label">XP</span><span class="info-val" id="info-xp">0</span></div>
            <div class="info-item" style="grid-column: span 3; text-align: left;"><span class="info-label">BIO / DESCRIÇÃO</span><span class="info-val" id="info-bio" style="font-family:'Rajdhani'; font-size: 0.9rem;">Nenhuma bio definida.</span></div>
        </div>
    </div>

    <div id="niche-modal" class="niche-modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="info-label" style="text-align:center">IDENTIDADE VISUAL (SEXO)</span>
            <div class="selector-grid">
                <div class="opt-btn" style="border-bottom: 2px solid #00d9ff" onclick="saveGender('masc')">MASCULINO</div>
                <div class="opt-btn" style="border-bottom: 2px solid #ff00ea" onclick="saveGender('fem')">FEMININO</div>
                <div class="opt-btn" style="background: linear-gradient(90deg, red, yellow, blue); border:none;" onclick="saveGender('other')">OUTROS</div>
            </div>

            <span class="info-label" style="text-align:center">PROTOCOLO COMERCIAL</span>
            <div class="selector-grid">
                <div class="opt-btn" onclick="saveRole('citizen')">CIDADÃO</div>
                <div class="opt-btn" onclick="saveRole('clothes')">ROUPAS</div>
                <div class="opt-btn" onclick="saveRole('shoes')">SAPATOS</div>
                <div class="opt-btn" onclick="saveRole('tech')">ELETRÔNICOS</div>
                <div class="opt-btn" onclick="saveRole('appliances')">ELETRODOMÉSTICOS</div>
                <div class="opt-btn" onclick="saveRole('auto')">VEÍCULOS</div>
                <div class="opt-btn" onclick="saveRole('jewelry')">JOIAS</div>
            </div>

            <span class="info-label" style="text-align:center">DADOS DO HABITAT</span>
            <input type="text" id="input-city" placeholder="Sua Cidade">
            <select id="input-state">
                <option value="">Selecione o Estado</option>
                <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amapá</option>
                <option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Ceará</option>
                <option value="DF">Distrito Federal</option><option value="ES">Espírito Santo</option><option value="GO">Goiás</option>
                <option value="MA">Maranhão</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option>
                <option value="MG">Minas Gerais</option><option value="PA">Pará</option><option value="PB">Paraíba</option>
                <option value="PR">Paraná</option><option value="PE">Pernambuco</option><option value="PI">Piauí</option>
                <option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option>
                <option value="RO">Rondônia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option>
                <option value="SP">São Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
            </select>
            <input type="text" id="input-bio" placeholder="Sua Bio (Breve)">
            <input type="url" id="input-link" placeholder="Link Externo (http://...)">

            <button onclick="handleManualSave()" style="width:100%; margin-top:15px; background:var(--gold); border:none; color:#000; padding:12px; border-radius:5px; font-family:Orbitron; font-size:0.7rem; font-weight:bold; cursor:pointer;">CONFIRMAR E SALVAR TUDO</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8", 
            authDomain: "minharifadigital.firebaseapp.com", 
            projectId: "minharifadigital", 
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const targetID = urlParams.get('id');

        const roles = {
            citizen: { label: "CIDADÃO", color: "#555" },
            clothes: { label: "MODA", color: "#00f2ff" },
            shoes: { label: "CALÇADOS", color: "#8b4513" },
            tech: { label: "ELETRÔNICOS", color: "#00ff88" },
            appliances: { label: "ELETRODOMÉSTICOS", color: "#ffcc00" },
            auto: { label: "VEÍCULOS", color: "#bd00ff" },
            jewelry: { label: "JOALHERIA", color: "#e5e5e5" }
        };

        const genders = {
            masc: { color: "#00d9ff" },
            fem: { color: "#ff00ea" },
            other: { color: "rainbow" }
        };

        let isOwner = false;
        let storeLink = "";
        let currentRole = 'citizen';
        let currentGender = 'masc';

        window.toggleNicheMenu = () => { if(isOwner) document.getElementById('niche-modal').style.display = 'flex'; };
        window.closeModal = (e) => { if(e.target.id === 'niche-modal') document.getElementById('niche-modal').style.display = 'none'; };

        if (targetID) {
            onSnapshot(doc(db, "usuarios", targetID), (snap) => {
                if (snap.exists()) updateHabitat(snap.data());
            });
            onAuthStateChanged(auth, user => { if(user && user.uid === targetID) isOwner = true; });
        }

        window.saveRole = async (roleKey) => { currentRole = roleKey; await executeUpdate(); };
        window.saveGender = async (genderKey) => { currentGender = genderKey; await executeUpdate(); };

        window.handleManualSave = async () => {
            await executeUpdate();
            document.getElementById('niche-modal').style.display = 'none';
        };

        async function executeUpdate() {
            if(!auth.currentUser) return;
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            try {
                await updateDoc(userRef, {
                    role: currentRole,
                    gender: currentGender,
                    temComercio: currentRole !== 'citizen',
                    cidade: document.getElementById('input-city').value,
                    estado: document.getElementById('input-state').value,
                    bio: document.getElementById('input-bio').value,
                    linkLoja: document.getElementById('input-link').value
                });
            } catch (e) { console.error(e); }
        }

        window.redirectStore = () => { if(storeLink) window.open(storeLink, '_blank'); };

        function updateHabitat(data) {
            currentRole = data.role || 'citizen';
            currentGender = data.gender || 'masc';
            storeLink = data.linkLoja || "";
            
            const config = roles[currentRole];
            document.documentElement.style.setProperty('--accent-color', config.color);
            
            const cube = document.getElementById('user-cube');
            cube.classList.remove('rainbow-mode');
            if(currentGender === 'other') {
                cube.classList.add('rainbow-mode');
            } else {
                const gColor = genders[currentGender].color;
                document.documentElement.style.setProperty('--identity-color', gColor);
            }

            document.getElementById('display-role').innerText = config.label;
            document.getElementById('display-name').innerText = (data.nome || "NEXUS").toUpperCase();
            document.getElementById('display-city').innerText = (data.cidade || "CIDADE").toUpperCase();
            document.getElementById('display-state').innerText = data.estado || "ESTADO";
            document.getElementById('info-id').innerText = `#${targetID.substring(0, 5).toUpperCase()}`;
            document.getElementById('info-xp').innerText = data.xp || 0;
            const level = Math.floor((data.xp || 0) / 1000) + 1;
            document.getElementById('info-lvl').innerText = level;
            document.getElementById('info-bio').innerText = data.bio || "Nenhuma bio definida.";
            document.getElementById('user-balance').innerText = `${(data.saldo || 0).toFixed(2)} NP`;

            const b = document.getElementById('user-building');
            b.style.height = (70 + (level * 18)) + "px";
            b.innerHTML = '<div class="building-door"></div>'; // Recria a portinha
            for(let i=0; i < (level * 3); i++){
                const w = document.createElement('div');
                w.className = "window active-win";
                b.appendChild(w);
            }
        }
    </script>
</body>
</html>
