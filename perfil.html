<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Habitat | Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent-color: #555; /* Cinza Neon Padrão */
            --gold: #ffcc00; 
            --bg-card: rgba(15, 15, 15, 0.95);
        }
        body { background: #000; color: #fff; font-family: 'Rajdhani'; margin: 0; overflow-x: hidden; }

        /* NAVEGAÇÃO GERAL */
        .top-nav { display: flex; justify-content: space-between; padding: 15px; position: absolute; width: 100%; box-sizing: border-box; z-index: 100; }
        .btn-back { background: var(--glass); border: 1px solid #333; color: #fff; padding: 5px 15px; border-radius: 5px; cursor: pointer; text-decoration: none; font-size: 0.8rem; font-family: 'Orbitron'; }

        /* HEADER COMPACTO */
        .habitat-header { padding: 50px 20px 10px; text-align: center; }
        .user-name { font-family: 'Orbitron'; font-size: 1.4rem; margin: 5px 0; text-shadow: 0 0 10px var(--accent-color); }
        .status-badge { font-size: 0.6rem; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; }

        /* MUNDO VISUAL COMPACTO */
        .world-view {
            position: relative; height: 320px; width: 100%;
            display: flex; align-items: flex-end; justify-content: center;
            perspective: 1000px; background: radial-gradient(circle at bottom, #0a1015 0%, #000 70%);
            gap: 10px; padding-bottom: 20px;
        }

        .identity-cube {
            width: 60px; height: 60px; z-index: 10; margin-bottom: 30px;
            background: var(--accent-color); box-shadow: 0 0 40px var(--accent-color);
            border-radius: 12px; animation: float 4s ease-in-out infinite;
        }

        .building-asset {
            width: 100px; background: #0a0a0a;
            border: 2px solid #222; border-bottom: none; display: flex; flex-wrap: wrap;
            padding: 8px; gap: 4px; transition: 0.5s; box-shadow: inset 0 0 15px #000;
        }

        .window { width: 10px; height: 10px; background: #111; border-radius: 1px; }
        .active-win { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }

        /* PAINEL DE CONTROLE (SÓ DONO) */
        .control-panel { background: var(--bg-card); padding: 20px; border-top: 1px solid #222; }
        .selector-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .opt-btn { 
            background: #111; border: 1px solid #333; color: #aaa; padding: 10px 5px; 
            border-radius: 8px; cursor: pointer; font-size: 0.6rem; font-family: 'Orbitron'; text-align: center;
        }
        .opt-btn.active { border-color: var(--gold); color: #fff; background: #1a1a1a; }

        /* VITRINE DE PRODUTOS */
        .store-section { padding: 20px; background: #050505; min-height: 200px; }
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .product-card { background: #111; border-radius: 10px; padding: 10px; border: 1px solid #222; }
        .product-img { width: 100%; height: 80px; background: #1a1a1a; border-radius: 5px; margin-bottom: 8px; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>
</head>
<body>

    <script type="module" src="nexus-overlay.js"></script>

    <nav class="top-nav">
        <a href="index.html" class="btn-back"> < VOLTAR</a>
        <div id="user-balance" style="color:var(--gold); font-family:Orbitron; font-size:0.7rem;">0.00 NP</div>
    </nav>

    <div class="habitat-header">
        <div class="status-badge" id="display-role">CIDADÃO</div>
        <div class="user-name" id="display-name">---</div>
    </div>

    <div class="world-view">
        <div id="user-cube" class="identity-cube"></div>
        <div id="user-building" class="building-asset"></div>
    </div>

    <div id="owner-controls" class="control-panel" style="display:none;">
        <span class="status-badge">Configurar Identidade</span>
        <div class="selector-grid">
            <div class="opt-btn active" onclick="setRole('citizen')">CIDADÃO</div>
            <div class="opt-btn" onclick="setRole('clothes')">ROUPAS</div>
            <div class="opt-btn" onclick="setRole('shoes')">SAPATOS</div>
            <div class="opt-btn" onclick="setRole('tech')">ELETRO</div>
            <div class="opt-btn" onclick="setRole('auto')">MOTOS/CARROS</div>
            <div class="opt-btn" onclick="setRole('jewelry')">JOIAS</div>
        </div>
    </div>

    <div id="store-area" class="store-section" style="display:none;">
        <span class="status-badge" style="color:#555">VITRINE DO COMERCIANTE</span>
        <div class="product-grid" id="product-list">
            <div class="product-card">
                <div class="product-img"></div>
                <div style="font-size:0.7rem; font-family:Orbitron;">ITEM EXEMPLO</div>
                <div style="color:var(--gold); font-size:0.8rem;">100.00 NP</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8", 
            authDomain: "minharifadigital.firebaseapp.com", 
            projectId: "minharifadigital", 
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const targetID = urlParams.get('id');

        const roles = {
            citizen: { label: "CIDADÃO", color: "#555" },
            clothes: { label: "MODA NEON", color: "#00f2ff" }, // Azul
            shoes: { label: "CALÇADOS", color: "#8b4513" }, // Marrom
            tech: { label: "TECH HUB", color: "#00ff88" }, // Verde
            auto: { label: "MOTORS", color: "#bd00ff" }, // Roxo
            jewelry: { label: "JOALHERIA", color: "#e5e5e5" } // Prata
        };

        if (targetID) {
            onSnapshot(doc(db, "usuarios", targetID), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    updateHabitat(data);
                }
            });

            onAuthStateChanged(auth, user => {
                if(user && user.uid === targetID) {
                    document.getElementById('owner-controls').style.display = 'block';
                }
            });
        }

        window.setRole = async (roleKey) => {
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            await updateDoc(userRef, {
                role: roleKey,
                temComercio: roleKey !== 'citizen'
            });
            // Feedback visual imediato nos botões
            document.querySelectorAll('.opt-btn').forEach(btn => btn.classList.remove('active'));
        };

        function updateHabitat(data) {
            const userRole = data.role || 'citizen';
            const config = roles[userRole];
            
            // Aplica Cores
            document.documentElement.style.setProperty('--accent-color', config.color);
            document.getElementById('display-role').innerText = config.label;
            document.getElementById('display-name').innerText = (data.nome || "USER").toUpperCase();
            document.getElementById('user-balance').innerText = `${(data.saldo || 0).toFixed(2)} NP`;

            // Altura do Prédio
            const level = Math.floor((data.xp || 0) / 1000) + 1;
            const b = document.getElementById('user-building');
            b.style.height = (80 + (level * 15)) + "px";
            
            // Janelas
            b.innerHTML = "";
            for(let i=0; i < (level * 3); i++){
                const w = document.createElement('div');
                w.className = "window active-win";
                b.appendChild(w);
            }

            // Mostra/Esconde Vitrine
            document.getElementById('store-area').style.display = data.temComercio ? 'block' : 'none';
        }
    </script>
</body>
</html>
