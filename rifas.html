<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rifas Progressivas IA v5.5.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f2ff; --green: #00ff88; --pink: #ff0055; --bg: #000; }
        body { background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; margin: 0; overflow-x: hidden; }
        
        .header { height: 60px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #111; font-family: 'Orbitron'; font-size: 0.7rem; position: relative; }
        .ads-space { background: rgba(255,255,255,0.02); border: 1px dashed #222; color: #333; text-align: center; padding: 10px; font-family: 'Orbitron'; font-size: 0.45rem; margin: 10px 15px; border-radius: 8px; }

        .level-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 10px 15px; scrollbar-width: none; }
        .level-slider::-webkit-scrollbar { display: none; }

        .level-card { min-width: 88vw; scroll-snap-align: center; background: #080808; border: 1px solid #151515; border-radius: 15px; padding: 12px; position: relative; box-sizing: border-box; }
        .level-card.locked { filter: grayscale(1) blur(2px); opacity: 0.3; pointer-events: none; }
        
        .level-header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #111; padding-bottom: 8px; }
        .level-title { font-family: 'Orbitron'; font-size: 0.55rem; color: var(--neon); letter-spacing: 1px; }
        .level-prize { font-family: 'Orbitron'; font-size: 1rem; color: var(--green); margin-top: 4px; }

        .rifa-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; }
        .num { background: #111; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-family: 'Orbitron'; border-radius: 3px; color: #333; border: 1px solid #1a1a1a; cursor: pointer; }
        
        /* Estados do N√∫mero */
        .num.selected { background: var(--neon); color: #000; border-color: #fff; box-shadow: 0 0 8px var(--neon); }
        .num.sold { background: #300 !important; color: #ff0000 !important; border: 1px solid #500 !important; pointer-events: none; opacity: 0.8; position: relative; }
        .num.sold::after { content: 'X'; position: absolute; font-size: 0.4rem; top: 1px; right: 2px; }

        .lock-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Orbitron'; font-size: 0.6rem; background: #000; padding: 5px 10px; border: 1px solid var(--pink); color: var(--pink); z-index: 5; display: none; }
        .level-card.locked .lock-msg { display: block; }

        #checkout { position: fixed; bottom: 0; width: 100%; background: #050505; border-top: 2px solid var(--neon); padding: 15px; box-sizing: border-box; transform: translateY(100%); transition: 0.4s ease; z-index: 100; }
        #checkout.active { transform: translateY(0); }
        .checkout-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn-action { font-family: 'Orbitron'; font-weight: bold; font-size: 0.75rem; width: 100%; padding: 15px; border-radius: 10px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="window.location.href='index.html'" style="background:none; border:none; color:var(--neon); font-size:1.2rem; position:absolute; left:15px;">‚¨Ö</button>
        RIFAS DA SORTE v5.5.1
    </div>

    <div class="ads-space">SUA PROPAGANDA AQUI</div>

    <div class="level-slider" id="main-slider">
        </div>

    <div class="ads-space">SUA PROPAGANDA AQUI</div>

    <div id="checkout">
        <div class="checkout-row">
            <div>
                <div style="font-size:0.5rem; color:#444; font-family:'Orbitron'; uppercase">N√öMEROS: <span id="num-list" style="color:var(--neon);">-</span></div>
                <div style="font-size:1.2rem; color:#fff; font-family:'Orbitron';">R$ <span id="total-price">0.00</span></div>
            </div>
            <div style="text-align:right">
                <div style="font-size:0.5rem; color:#444; font-family:'Orbitron'; uppercase">SALDO</div>
                <div id="u-balance" style="font-size:0.8rem; color:var(--green); font-family:'Orbitron';">R$ 0.00</div>
            </div>
        </div>
        <button id="btn-pay" class="btn-action" style="background:var(--green); color:#000;" onclick="confirmarCompra()">FINALIZAR COMPRA</button>
        <button id="btn-deposit" class="btn-action" style="background:var(--pink); color:#fff; display:none;" onclick="window.location.href='depositar.html'">DEPOSITAR AGORA</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8",
            authDomain: "minharifadigital.firebaseapp.com",
            projectId: "minharifadigital",
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const precoCota = 8.0;
        let user, saldoAtual = 0, selecionados = [], vendidosGlobal = [];

        // 1. GERA√á√ÉO DIN√ÇMICA
        const niveis = [
            { id: 1, start: 1, end: 50, prize: 110 },
            { id: 2, start: 51, end: 100, prize: 220 },
            { id: 3, start: 101, end: 150, prize: 330 },
            { id: 4, start: 151, end: 200, prize: 440 }
        ];

        const slider = document.getElementById('main-slider');
        niveis.forEach(lvl => {
            const card = document.createElement('div');
            card.className = `level-card locked`;
            card.id = `lvl-${lvl.id}`;
            card.innerHTML = `
                <div class="lock-msg">ESGOTAR N√çVEL ANTERIOR üîí</div>
                <div class="level-header">
                    <div class="level-title">N√çVEL 0${lvl.id} (NUMS ${lvl.start}-${lvl.end})</div>
                    <div class="level-prize">PR√äMIO R$ ${lvl.prize},00</div>
                </div>
                <div class="rifa-grid" id="grid-${lvl.id}"></div>
            `;
            slider.appendChild(card);
            const grid = document.getElementById(`grid-${lvl.id}`);
            for(let i=lvl.start; i<=lvl.end; i++) {
                const n = document.createElement('div');
                n.className = 'num';
                n.id = `num-${i}`;
                n.innerText = String(i).padStart(2,'0');
                n.onclick = () => window.toggleNum(i, n);
                grid.appendChild(n);
            }
        });

        // 2. SINCRONIZA√á√ÉO GLOBAL (VENDIDOS E N√çVEIS)
        onSnapshot(doc(db, "rifas_vendas", "global"), (snap) => {
            const data = snap.data();
            if (!data) return;
            vendidosGlobal = data.vendidos || [];
            
            // Marcar vendidos
            vendidosGlobal.forEach(num => {
                const el = document.getElementById(`num-${num}`);
                if (el) el.classList.add('sold');
            });

            // L√≥gica de Desbloqueio de N√≠veis
            document.getElementById('lvl-1').classList.remove('locked');
            if (vendidosGlobal.filter(n => n <= 50).length >= 50) document.getElementById('lvl-2').classList.remove('locked');
            if (vendidosGlobal.filter(n => n > 50 && n <= 100).length >= 50) document.getElementById('lvl-3').classList.remove('locked');
            if (vendidosGlobal.filter(n => n > 100 && n <= 150).length >= 50) document.getElementById('lvl-4').classList.remove('locked');
        });

        // 3. MONITORAR USU√ÅRIO
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                onSnapshot(doc(db, "usuarios", u.uid), (snap) => {
                    saldoAtual = snap.data().saldo || 0;
                    document.getElementById('u-balance').innerText = `R$ ${saldoAtual.toFixed(2)}`;
                    atualizarPainel();
                });
            }
        });

        window.toggleNum = (n, el) => {
            if (el.classList.contains('sold')) return;
            if (selecionados.includes(n)) {
                selecionados = selecionados.filter(i => i !== n);
                el.classList.remove('selected');
            } else {
                selecionados.push(n);
                el.classList.add('selected');
            }
            atualizarPainel();
        };

        function atualizarPainel() {
            const total = selecionados.length * precoCota;
            document.getElementById('total-price').innerText = total.toFixed(2);
            document.getElementById('num-list').innerText = selecionados.sort((a,b)=>a-b).join(', ') || '-';
            document.getElementById('checkout').classList.toggle('active', selecionados.length > 0);
            
            const insuficiente = total > saldoAtual;
            document.getElementById('btn-pay').style.display = insuficiente ? 'none' : 'block';
            document.getElementById('btn-deposit').style.display = insuficiente ? 'block' : 'none';
        }

        window.confirmarCompra = async () => {
            const total = selecionados.length * precoCota;
            if(!confirm(`Confirmar R$ ${total.toFixed(2)}?`)) return;

            try {
                const userRef = doc(db, "usuarios", user.uid);
                const globalRef = doc(db, "rifas_vendas", "global");

                await updateDoc(userRef, { saldo: increment(-total), xp: increment(selecionados.length * 10) });
                await updateDoc(globalRef, { vendidos: arrayUnion(...selecionados) });

                alert("Sucesso! N√∫meros reservados.");
                selecionados = [];
                location.reload();
            } catch(e) { alert("Erro na reserva."); }
        };
    </script>
</body>
</html>
