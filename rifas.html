<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus S - Campanhas Ativas</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --green: #00ff88; --pink: #ff0055; --bg: #000; --red-sold: #ff0000; }
        body { background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; margin: 0; overflow-x: hidden; }
        
        .header { height: 60px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #111; font-family: 'Orbitron'; font-size: 0.7rem; position: relative; }
        .ads-space { background: rgba(255,255,255,0.02); border: 1px dashed #222; color: #333; text-align: center; padding: 10px; font-family: 'Orbitron'; font-size: 0.45rem; margin: 10px 15px; border-radius: 8px; }

        .my-tokens-box { margin: 10px 15px; padding: 10px; background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; }
        .my-tokens-title { font-family: 'Orbitron'; font-size: 0.5rem; color: var(--green); margin-bottom: 5px; text-transform: uppercase; }
        .my-tokens-list { font-size: 0.8rem; color: #aaa; word-wrap: break-word; }

        .level-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 10px 15px; scrollbar-width: none; }
        .level-slider::-webkit-scrollbar { display: none; }

        .level-card { min-width: 88vw; scroll-snap-align: center; background: #080808; border: 1px solid #151515; border-radius: 15px; padding: 12px; position: relative; box-sizing: border-box; }
        .level-card.locked { filter: grayscale(1) blur(2px); opacity: 0.3; pointer-events: none; }
        
        .level-header { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #111; padding-bottom: 8px; }
        .level-title { font-family: 'Orbitron'; font-size: 0.55rem; color: var(--neon); letter-spacing: 1px; }
        .level-prize { font-family: 'Orbitron'; font-size: 1rem; color: var(--green); margin-top: 4px; }

        .rifa-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; }
        .num { background: #111; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-family: 'Orbitron'; border-radius: 3px; color: #333; border: 1px solid #1a1a1a; cursor: pointer; transition: 0.2s; }
        
        .num.selected { background: var(--neon); color: #000; border-color: #fff; box-shadow: 0 0 8px var(--neon); }
        .num.sold { background: #300 !important; color: var(--red-sold) !important; border: 1px solid #600 !important; pointer-events: none; position: relative; box-shadow: inset 0 0 5px #f00; }
        .num.sold::after { content: 'X'; position: absolute; font-size: 0.4rem; top: 1px; right: 2px; color: #f00; }

        .lock-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Orbitron'; font-size: 0.6rem; background: #000; padding: 5px 10px; border: 1px solid var(--pink); color: var(--pink); z-index: 5; display: none; }
        .level-card.locked .lock-msg { display: block; }

        #winner-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .winner-token { font-family: 'Orbitron'; font-size: 5rem; color: var(--neon); text-shadow: 0 0 20px var(--neon); }

        #checkout { position: fixed; bottom: 0; width: 100%; background: #050505; border-top: 2px solid var(--neon); padding: 15px; box-sizing: border-box; transform: translateY(100%); transition: 0.4s ease; z-index: 100; }
        #checkout.active { transform: translateY(0); }
        .btn-action { font-family: 'Orbitron'; font-weight: bold; font-size: 0.75rem; width: 100%; padding: 15px; border-radius: 10px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="winner-overlay">
        <div style="font-family:'Orbitron'; color:var(--green); margin-bottom:10px;">TOKEN PREMIADO!</div>
        <div class="winner-token" id="display-winner-num">00</div>
        <button class="btn-action" style="width:200px; margin-top:20px; background:var(--neon);" onclick="document.getElementById('winner-overlay').style.display='none'">COLETAR RECOMPENSA</button>
    </div>

    <div class="header">
        <button onclick="window.location.href='index.html'" style="background:none; border:none; color:var(--neon); font-size:1.2rem; position:absolute; left:15px;">‚¨Ö</button>
        NEXUS CAMPANHAS v5.5.2
    </div>

    <div class="ads-space">ACESSANDO SERVIDOR DE TOKENS...</div>

    <div class="level-slider" id="main-slider"></div>

    <div class="my-tokens-box">
        <div class="my-tokens-title">Minhas Aloca√ß√µes Privadas</div>
        <div id="my-tokens-display" class="my-tokens-list">Nenhum token alocado.</div>
    </div>

    <div class="ads-space">ESPA√áO PARA ADS PARCEIROS</div>

    <div id="checkout">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
                <div style="font-size:0.5rem; color:#444; font-family:'Orbitron';">TOKENS ALOCADOS: <span id="num-list" style="color:var(--neon);">-</span></div>
                <div style="font-size:1.2rem; color:#fff; font-family:'Orbitron';"><span id="total-price">0</span> <span style="font-size: 0.6rem; color: #555;">NP</span></div>
            </div>
            <div style="text-align:right">
                <div style="font-size:0.5rem; color:#444; font-family:'Orbitron';">DISPON√çVEL</div>
                <div id="u-balance" style="font-size:0.8rem; color:var(--green); font-family:'Orbitron';">0 NP</div>
            </div>
        </div>
        <button id="btn-pay" class="btn-action" style="background:var(--green); color:#000;" onclick="confirmarCompra()">CONFIRMAR ALOCA√á√ÉO</button>
        <button id="btn-deposit" class="btn-action" style="background:var(--pink); color:#fff; display:none;" onclick="window.location.href='deposito.html'">OBTER MAIS NP</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, increment, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8",
            authDomain: "minharifadigital.firebaseapp.com",
            projectId: "minharifadigital",
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const custoPorToken = 8;
        let user, saldoAtual = 0, selecionados = [], vendidosGlobal = [], meusTokens = [];

        const niveis = [
            { id: 1, start: 1, end: 50, prize: 1100 },
            { id: 2, start: 51, end: 100, prize: 2200 },
            { id: 3, start: 101, end: 150, prize: 3300 },
            { id: 4, start: 151, end: 200, prize: 4400 }
        ];

        const slider = document.getElementById('main-slider');
        niveis.forEach(lvl => {
            const card = document.createElement('div');
            card.className = `level-card ${lvl.id === 1 ? '' : 'locked'}`;
            card.id = `lvl-${lvl.id}`;
            card.innerHTML = `
                <div class="lock-msg">ESGOTAR N√çVEL ANTERIOR üîí</div>
                <div class="level-header">
                    <div class="level-title">CAMPANHA 0${lvl.id} (${lvl.start}-${lvl.end})</div>
                    <div class="level-prize">RECOMPENSA ${lvl.prize} NP</div>
                </div>
                <div class="rifa-grid" id="grid-${lvl.id}"></div>
            `;
            slider.appendChild(card);
            const grid = document.getElementById(`grid-${lvl.id}`);
            for(let i=lvl.start; i<=lvl.end; i++) {
                const n = document.createElement('div');
                n.className = 'num';
                n.id = `num-${i}`;
                n.innerText = String(i).padStart(2,'0');
                n.onclick = () => window.toggleNum(i, n);
                grid.appendChild(n);
            }
        });

        onSnapshot(doc(db, "rifas_vendas", "global"), (snap) => {
            const data = snap.data();
            vendidosGlobal = data ? (data.vendidos || []) : [];
            
            document.querySelectorAll('.num').forEach(el => el.classList.remove('sold'));
            vendidosGlobal.forEach(num => {
                const el = document.getElementById(`num-${num}`);
                if (el) el.classList.add('sold');
            });

            const v1 = vendidosGlobal.filter(n => n <= 50).length;
            const v2 = vendidosGlobal.filter(n => n > 50 && n <= 100).length;
            const v3 = vendidosGlobal.filter(n => n > 100 && n <= 150).length;

            if (v1 >= 50) document.getElementById('lvl-2')?.classList.remove('locked');
            if (v2 >= 50) document.getElementById('lvl-3')?.classList.remove('locked');
            if (v3 >= 50) document.getElementById('lvl-4')?.classList.remove('locked');
            
            verificarVencedorGlobal(data);
        });

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                onSnapshot(doc(db, "usuarios", u.uid), (snap) => {
                    const data = snap.data();
                    if(data) {
                        saldoAtual = data.saldo || 0;
                        meusTokens = data.meus_tokens || [];
                        document.getElementById('u-balance').innerText = `${Math.floor(saldoAtual)} NP`;
                        document.getElementById('my-tokens-display').innerText = meusTokens.length > 0 ? meusTokens.sort((a,b)=>a-b).join(', ') : 'Nenhum token alocado.';
                        atualizarPainel();
                    }
                });
            } else { window.location.href = "login.html"; }
        });

        function verificarVencedorGlobal(data) {
            if (data && data.sorteado && meusTokens.includes(data.sorteado)) {
                document.getElementById('display-winner-num').innerText = String(data.sorteado).padStart(2,'0');
                document.getElementById('winner-overlay').style.display = 'flex';
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#00f2ff', '#00ff88', '#ff0055'] });
            }
        }

        window.toggleNum = (n, el) => {
            if (el.classList.contains('sold')) return;
            if (selecionados.includes(n)) {
                selecionados = selecionados.filter(i => i !== n);
                el.classList.remove('selected');
            } else {
                selecionados.push(n);
                el.classList.add('selected');
            }
            atualizarPainel();
        };

        function atualizarPainel() {
            const total = selecionados.length * custoPorToken;
            document.getElementById('total-price').innerText = total;
            document.getElementById('num-list').innerText = selecionados.sort((a,b)=>a-b).join(', ') || '-';
            document.getElementById('checkout').classList.toggle('active', selecionados.length > 0);
            const insuficiente = total > saldoAtual;
            document.getElementById('btn-pay').style.display = insuficiente ? 'none' : 'block';
            document.getElementById('btn-deposit').style.display = insuficiente ? 'block' : 'none';
        }

        window.confirmarCompra = async () => {
            const total = selecionados.length * custoPorToken;
            if (saldoAtual < total || !confirm(`Confirmar aloca√ß√£o de ${total} NP?`)) return;

            try {
                const userRef = doc(db, "usuarios", user.uid);
                const globalRef = doc(db, "rifas_vendas", "global");

                await updateDoc(userRef, { 
                    saldo: increment(-total), 
                    meus_tokens: arrayUnion(...selecionados),
                    xp: increment(selecionados.length * 10) 
                });
                
                await setDoc(globalRef, { vendidos: arrayUnion(...selecionados) }, { merge: true });

                // L√≥gica de Premia√ß√£o por N√≠vel Completo
                const snap = await getDoc(globalRef);
                const todosVendidos = snap.data().vendidos || [];
                let premioTotal = 0;
                
                niveis.forEach(lvl => {
                    const vendidosNoNivel = todosVendidos.filter(n => n >= lvl.start && n <= lvl.end).length;
                    if (vendidosNoNivel >= 50) {
                        const meusNesseNivel = selecionados.filter(n => n >= lvl.start && n <= lvl.end).length;
                        if (meusNesseNivel > 0) premioTotal += lvl.prize; 
                    }
                });

                if (premioTotal > 0) await updateDoc(userRef, { saldo: increment(premioTotal) });

                alert("Aloca√ß√£o conclu√≠da!");
                selecionados = [];
                atualizarPainel();
            } catch(e) { alert("Erro no servidor Nexus."); console.error(e); }
        };
    </script>
</body>
</html>
