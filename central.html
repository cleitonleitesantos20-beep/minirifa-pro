<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IA Central - RoboSorteio</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        .xp-section { border: 1px solid var(--neon); background: rgba(0, 242, 255, 0.05); }
        .xp-bar-container { background: #000; border-radius: 20px; height: 15px; width: 100%; margin: 10px 0; border: 1px solid #333; overflow: hidden; }
        .xp-fill { background: linear-gradient(90deg, var(--neon), var(--green)); height: 100%; width: 0%; transition: 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .game-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .scratch-area { width: 100%; height: 100px; background: #222; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; transition: 0.3s; color: #888; font-family: 'Orbitron'; font-size: 0.8rem; }
        .scratch-area:hover { border-color: var(--neon); color: #fff; }
        
        .mining-box { background: #000; padding: 10px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.7rem; color: var(--green); height: 80px; overflow: hidden; display: none; border: 1px solid #111; }
        
        textarea { width: 100%; background: #000; color: #fff; border: 1px solid #333; padding: 12px; border-radius: 8px; font-family: 'Rajdhani'; resize: none; margin-bottom: 10px; }
        .btn-ad { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: #1a1a1d; border: 1px solid #333; border-radius: 8px; color: #fff; text-decoration: none; font-weight: bold; font-size: 0.85rem; }
        .btn-ad span { color: var(--green); font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="header">‚öôÔ∏è CENTRAL DE EXPANS√ÉO IA</div>

    <div class="container">
        <button onclick="window.location.href='index.html'" class="btn-small" style="float:none; margin-bottom: 20px; border-color: var(--neon); color: var(--neon);">‚¨Ö VOLTAR AO PAINEL</button>

        <div class="card xp-section">
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                    <p style="font-size: 0.7rem; color: var(--neon);">SISTEMA EVOLUTIVO</p>
                    <h2 style="font-family: 'Orbitron';">N√çVEL <span id="lvl-display">1</span></h2>
                </div>
                <div style="text-align: right;">
                    <span id="xp-text" style="font-size: 0.8rem; font-weight: bold;">0/100 XP</span>
                </div>
            </div>
            <div class="xp-bar-container">
                <div id="xp-bar" class="xp-fill"></div>
            </div>
            <p style="font-size: 0.65rem; color: #666; text-align: center;">A cada novo n√≠vel, a IA injeta <b>R$ 0,10</b> no seu saldo.</p>
        </div>

        <div class="card">
            <h3 style="font-size: 0.9rem; margin-bottom: 10px;">üîó SEU LINK DE CONVITE</h3>
            <input type="text" id="share-link" readonly style="margin-bottom: 10px; font-size: 0.7rem; color: var(--neon);">
            <button onclick="copyLink()" class="btn-outline">COPIAR LINK</button>
        </div>

        <div class="game-grid">
            <div class="card">
                <h4 style="margin-bottom: 10px; font-size: 0.8rem;">üé∞ RASPADEIRA IA (DI√ÅRIA)</h4>
                <div id="scratch-box" class="scratch-area" onclick="playScratch()">CLIQUE PARA RASPAR</div>
            </div>

            <div class="card">
                <h4 style="margin-bottom: 10px; font-size: 0.8rem;">‚õèÔ∏è MINERA√á√ÉO DE C√ìDIGO</h4>
                <div id="mining-status" class="mining-box"></div>
                <button id="btn-mine" onclick="startMining()" class="btn-primary">INICIAR (0.03 + 5XP)</button>
            </div>
        </div>

        <div class="card">
            <h4 style="margin-bottom: 15px; font-size: 0.8rem; color: #ffd700;">üíé PATROCINADORES (GANHE XP)</h4>
            <a href="#" onclick="visitAd('https://google.com')" class="btn-ad">VISITAR SITE PARCEIRO 1 <span>+5 XP</span></a>
            <a href="#" onclick="visitAd('https://google.com')" class="btn-ad">VER OFERTA EXCLUSIVA 2 <span>+5 XP</span></a>
        </div>

        <div class="card">
            <h4 style="margin-bottom: 10px; font-size: 0.8rem;">üêû SUPORTE E BUGS</h4>
            <textarea id="fb-text" rows="3" placeholder="Algo n√£o funcionou? Relate aqui para a IA..."></textarea>
            <button onclick="sendFeedback()" class="btn-outline">ENVIAR RELAT√ìRIO</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8",
            authDomain: "minharifadigital.firebaseapp.com",
            projectId: "minharifadigital",
            storageBucket: "minharifadigital.firebasestorage.app",
            messagingSenderId: "59630725905",
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let user = null;
        let userData = null;

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                onSnapshot(doc(db, "usuarios", u.uid), (snap) => {
                    userData = snap.data();
                    if(!userData) return;
                    
                    // Link Afiliado
                    document.getElementById('share-link').value = window.location.origin + "/index.html?ref=" + userData.meuCodigo;

                    // L√≥gica de N√≠vel e XP
                    const xpTotal = userData.xp || 0;
                    const level = Math.floor(xpTotal / 100) + 1;
                    const xpAtual = xpTotal % 100;
                    
                    document.getElementById('lvl-display').innerText = level;
                    document.getElementById('xp-text').innerText = `${xpAtual}/100 XP`;
                    document.getElementById('xp-bar').style.width = xpAtual + "%";

                    // Trava visual games
                    const hoje = new Date().toISOString().split('T')[0];
                    if(userData.lastScratch === hoje) {
                        document.getElementById('scratch-box').innerText = "‚úÖ CONCLU√çDO HOJE";
                        document.getElementById('scratch-box').style.pointerEvents = "none";
                    }
                    if(userData.lastMine === hoje) {
                        document.getElementById('btn-mine').disabled = true;
                        document.getElementById('btn-mine').innerText = "LIMITADO (1X DIA)";
                    }
                });
            } else { window.location.href = 'index.html'; }
        });

        // SISTEMA DE RECOMPENSA POR N√çVEL
        async function ganharXP(qtd) {
            const xpAntigo = userData.xp || 0;
            const novoXP = xpAntigo + qtd;
            const levelAntigo = Math.floor(xpAntigo / 100);
            const levelNovo = Math.floor(novoXP / 100);

            let updates = { xp: increment(qtd) };

            if (levelNovo > levelAntigo) {
                const bonus = (levelNovo - levelAntigo) * 0.10;
                updates.saldo = increment(bonus);
                alert(`üöÄ N√çVEL UP! Voc√™ alcan√ßou o n√≠vel ${levelNovo + 1} e a IA te enviou R$ ${bonus.toFixed(2)}!`);
            }

            await updateDoc(doc(db, "usuarios", user.uid), updates);
        }

        window.playScratch = async () => {
            const hoje = new Date().toISOString().split('T')[0];
            if(userData.lastScratch === hoje) return;
            
            document.getElementById('scratch-box').innerText = "üí∞ +R$ 0.03";
            await updateDoc(doc(db, "usuarios", user.uid), {
                saldo: increment(0.03),
                lastScratch: hoje
            });
            await ganharXP(2);
        };

        window.startMining = () => {
            const hoje = new Date().toISOString().split('T')[0];
            if(userData.lastMine === hoje) return;

            const btn = document.getElementById('btn-mine');
            const box = document.getElementById('mining-status');
            btn.style.display = 'none';
            box.style.display = 'block';

            let ciclo = 0;
            const timer = setInterval(() => {
                box.innerText += `> SEARCHING_BLOCK_${Math.random().toString(16).toUpperCase().slice(2,6)}\n`;
                box.scrollTop = box.scrollHeight;
                ciclo++;
                if(ciclo > 15) {
                    clearInterval(timer);
                    finalizarMineracao(hoje);
                }
            }, 800);
        };

        async function finalizarMineracao(data) {
            await updateDoc(doc(db, "usuarios", user.uid), {
                saldo: increment(0.03),
                lastMine: data
            });
            await ganharXP(5);
            alert("Minera√ß√£o finalizada com sucesso!");
            location.reload();
        }

        window.visitAd = async (url) => {
            window.open(url, '_blank');
            await ganharXP(5);
        };

        window.sendFeedback = async () => {
            const msg = document.getElementById('fb-text').value;
            if(!msg) return alert("Escreva algo antes de enviar.");
            await setDoc(doc(db, "feedbacks", Date.now().toString()), {
                usuario: user.email,
                mensagem: msg,
                data: new Date().toLocaleString()
            });
            alert("Feedback enviado para an√°lise da IA!");
            document.getElementById('fb-text').value = "";
        };

        window.copyLink = () => {
            const link = document.getElementById('share-link');
            link.select();
            document.execCommand("copy");
            alert("Link de indica√ß√£o copiado!");
        };
    </script>
</body>
</html>