<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minigames $$$</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos espec√≠ficos para as novas fun√ß√µes */
        .scratch-area { width: 100%; height: 80px; background: #222; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; color: #888; transition: 0.3s; }
        
        /* 3. Anima√ß√£o da Raspadinha */
        .scratch-active { animation: shake 0.3s infinite; background: var(--neon) !important; color: #000 !important; font-weight: bold; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-3px, 0px) rotate(1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        /* 4. Anima√ß√£o de Pixels da Minera√ß√£o */
        .mining-canvas { width: 100%; height: 80px; background: #000; border-radius: 10px; display: none; position: relative; overflow: hidden; border: 1px solid #222; }
        .pixel { position: absolute; width: 6px; height: 6px; background: #00ff00; box-shadow: 0 0 5px #00ff00; border-radius: 1px; }

        .btn-ad:disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        .xp-bar-bg { background: #111; height: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid #333; overflow: hidden; }
        .xp-bar-fill { background: linear-gradient(90deg, var(--neon), #00ff88); height: 100%; width: 0%; transition: 1s ease-out; }
    </style>
</head>
<body>

    <div class="header">‚öôÔ∏è MINIGAMES $$$</div>

    <div class="container">
        <button onclick="window.location.href='index.html'" class="btn-small" style="float:none; margin-bottom: 20px;">‚¨Ö VOLTAR</button>

        <div class="card">
            <h2 style="font-family: 'Orbitron'; font-size: 1.2rem;">N√çVEL <span id="lvl-display">1</span></h2>
            <div class="xp-bar-bg">
                <div id="xp-bar" class="xp-bar-fill"></div>
            </div>
            <p id="xp-status" style="font-size: 0.7rem; color: #666; margin-top: 5px; text-align: center;">0/100 XP</p>
        </div>

        <div class="card">
            <h4 style="margin-bottom: 10px;">üé∞ RASPADINHA DI√ÅRIA</h4>
            <div id="scratch-box" class="scratch-area" onclick="playScratch()">CLIQUE PARA RASPAR</div>
        </div>

        <div class="card">
            <h4 style="margin-bottom: 10px;">‚õèÔ∏è MINERA√á√ÉO PIXEL</h4>
            <div id="mining-status" class="mining-canvas"></div>
            <button id="btn-mine" onclick="startMining()" class="btn-primary">INICIAR MINERA√á√ÉO (R$ 0.03)</button>
        </div>

        <div class="card">
            <h4 style="margin-bottom: 10px;">üíé LOJAS PARCEIRAS (1X DIA)</h4>
            <button id="ad-1" onclick="visitAd('https://shopee.com.br', 'ad-1')" class="btn-outline" style="width:100%; margin-bottom:10px;">üõí ACESSAR SHOPEE (+5 XP)</button>
            <button id="ad-2" onclick="visitAd('https://www.mercadolivre.com.br', 'ad-2')" class="btn-outline" style="width:100%;">üì¶ MERCADO LIVRE (+5 XP)</button>
        </div>

        <div class="card">
            <h4>üêû RELATAR BUG</h4>
            <textarea id="fb-text" placeholder="Descreva o erro..." style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:5px; margin-top:10px; font-family:'Rajdhani';"></textarea>
            <button onclick="sendFeedback()" class="btn-primary" style="margin-top:10px;">ENVIAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8",
            authDomain: "minharifadigital.firebaseapp.com",
            projectId: "minharifadigital",
            storageBucket: "minharifadigital.firebasestorage.app",
            messagingSenderId: "59630725905",
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let user = null;
        let userData = null;

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                onSnapshot(doc(db, "usuarios", u.uid), (snap) => {
                    userData = snap.data();
                    if(userData) renderizarDados();
                });
            } else { window.location.href = 'index.html'; }
        });

        function renderizarDados() {
            const xp = userData.xp || 0;
            const lvl = Math.floor(xp / 100) + 1;
            const xpLvl = xp % 100;
            
            document.getElementById('lvl-display').innerText = lvl;
            document.getElementById('xp-bar').style.width = xpLvl + "%";
            document.getElementById('xp-status').innerText = `${xpLvl}/100 XP`;

            const hoje = new Date().toISOString().split('T')[0];
            if(userData.lastScratch === hoje) document.getElementById('scratch-box').innerText = "‚úÖ J√Å RASPADO";
            if(userData.lastMine === hoje) {
                document.getElementById('btn-mine').disabled = true;
                document.getElementById('btn-mine').innerText = "CONCLU√çDO";
            }
            if(userData.lastAd1 === hoje) document.getElementById('ad-1').disabled = true;
            if(userData.lastAd2 === hoje) document.getElementById('ad-2').disabled = true;
        }

        async function darXP(qtd) {
            const xpAntigo = userData.xp || 0;
            const novoXP = xpAntigo + qtd;
            const lvlAntigo = Math.floor(xpAntigo / 100);
            const lvlNovo = Math.floor(novoXP / 100);

            let upd = { xp: increment(qtd) };
            if(lvlNovo > lvlAntigo) {
                upd.saldo = increment(0.10);
                alert(`‚ö° N√çVEL UP! +R$ 0.10`);
            }
            await updateDoc(doc(db, "usuarios", user.uid), upd);
        }

        window.playScratch = async () => {
            const hoje = new Date().toISOString().split('T')[0];
            if(userData.lastScratch === hoje) return;

            const box = document.getElementById('scratch-box');
            box.classList.add('scratch-active');
            box.innerText = "RASPANDO...";

            setTimeout(async () => {
                box.classList.remove('scratch-active');
                box.innerText = "‚ú® +R$ 0.03";
                await updateDoc(doc(db, "usuarios", user.uid), {
                    saldo: increment(0.03),
                    lastScratch: hoje
                });
                await darXP(2);
            }, 2000);
        };

        window.startMining = () => {
            const hoje = new Date().toISOString().split('T')[0];
            if(userData.lastMine === hoje) return;

            const status = document.getElementById('mining-status');
            const btn = document.getElementById('btn-mine');
            btn.style.display = 'none';
            status.style.display = 'block';

            for(let i=0; i<40; i++) {
                setTimeout(() => {
                    const p = document.createElement('div');
                    p.className = 'pixel';
                    p.style.left = Math.random() * 95 + "%";
                    p.style.top = Math.random() * 85 + "%";
                    status.appendChild(p);
                    p.animate([{transform:'scale(0)'},{transform:'scale(1)'},{transform:'scale(0)', opacity:0}], 1500);
                }, i * 150);
            }

            setTimeout(async () => {
                await updateDoc(doc(db, "usuarios", user.uid), {
                    saldo: increment(0.03),
                    lastMine: hoje
                });
                await darXP(5);
                alert("Minera√ß√£o Conclu√≠da!");
                location.reload();
            }, 6000);
        };

        window.visitAd = async (url, id) => {
            const hoje = new Date().toISOString().split('T')[0];
            window.open(url, '_blank');
            let upd = { xp: increment(5) };
            upd[id === 'ad-1' ? 'lastAd1' : 'lastAd2'] = hoje;
            await updateDoc(doc(db, "usuarios", user.uid), upd);
        };

        window.sendFeedback = async () => {
            const msg = document.getElementById('fb-text').value;
            if(!msg) return;
            await setDoc(doc(db, "feedbacks", Date.now().toString()), {
                user: user.email,
                msg: msg,
                date: new Date().toISOString()
            });
            alert("Feedback enviado!");
            document.getElementById('fb-text').value = "";
        };
    </script>
</body>
</html>
