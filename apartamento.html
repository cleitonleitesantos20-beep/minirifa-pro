<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusVL - Apartamento</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --user-color: #00f2ff;
            --bg-dark: #050505;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: var(--bg-dark);
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* ÁREA DO APARTAMENTO */
        #apartment-viewport {
            flex-grow: 1;
            position: relative;
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #111 0%, #000 100%);
        }

        /* PERSONAGEM (LOSANGO) */
        #protagonist {
            position: absolute;
            width: 40px;
            height: 40px;
            background: var(--user-color);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            filter: drop-shadow(0 0 20px var(--user-color));
            z-index: 100;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        /* MÓVEIS GEOMÉTRICOS */
        .furniture {
            position: absolute;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .furniture:hover { border-color: #fff; transform: scale(1.05); }

        /* PAINEL LATERAL (LOJA/MODIFICAÇÃO) */
        #ui-panel {
            width: 300px;
            background: rgba(10, 10, 10, 0.95);
            border-left: 2px solid #222;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 200;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-family: 'Orbitron';
            font-size: 12px;
            color: var(--user-color);
            letter-spacing: 2px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .shop-item {
            background: #111;
            padding: 10px;
            border: 1px solid #222;
            cursor: pointer;
            transition: 0.2s;
        }
        .shop-item:hover { border-color: var(--user-color); background: #1a1a1a; }
        .shop-item p { font-size: 10px; color: #888; margin-top: 5px; }

        .controls { display: flex; flex-direction: column; gap: 10px; }
        
        button {
            background: none;
            border: 1px solid var(--user-color);
            color: var(--user-color);
            padding: 8px;
            font-family: 'Orbitron';
            font-size: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover { background: var(--user-color); color: #000; }

        input[type="color"] {
            width: 100%; height: 30px; border: none; background: none; cursor: pointer;
        }

        .np-display {
            font-family: 'Orbitron';
            color: #ffcc00;
            font-size: 14px;
            text-align: center;
            background: rgba(255, 204, 0, 0.1);
            padding: 10px;
        }
    </style>
</head>
<body>

    <div id="apartment-viewport">
        <div id="protagonist"></div>
        </div>

    <aside id="ui-panel">
        <div class="np-display" id="balance">0.00 NP</div>

        <div class="section-title">EXPANDIR APARTAMENTO</div>
        <div class="controls">
            <div class="shop-item" onclick="buyFurniture('rect')">
                <strong>BLOCO RETANGULAR</strong>
                <p>CUSTO: 500 NP (R$ 5,00)</p>
            </div>
            <div class="shop-item" onclick="buyFurniture('cube')">
                <strong>BLOCO QUADRADO</strong>
                <p>CUSTO: 300 NP (R$ 3,00)</p>
            </div>
            <div class="shop-item" onclick="buyFurniture('circle')">
                <strong>MÓDULO REDONDO</strong>
                <p>CUSTO: 700 NP (R$ 7,00)</p>
            </div>
        </div>

        <div id="edit-menu" style="display:none;">
            <div class="section-title">CUSTOMIZAR SELECIONADO</div>
            <div class="controls">
                <label style="font-size: 10px;">COR DO NEON:</label>
                <input type="color" id="color-picker" onchange="updateFurnitureColor(this.value)">
                <p style="font-size: 8px; color: #666;">Taxa de alteração: 100 NP</p>
                <button onclick="removeFurniture()">DELETAR OBJETO</button>
            </div>
        </div>

        <button style="margin-top:auto;" onclick="saveApartment()">SALVAR CONFIGURAÇÃO</button>
        <button onclick="window.location.href='dashboard.html'">VOLTAR AO MAPA</button>
    </aside>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8", 
            projectId: "minharifadigital" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const userId = localStorage.getItem('userId') || "TEST_USER"; 
        let userNP = 5000; // Simulação de saldo inicial
        let selectedElement = null;

        // Configurar cor do protagonista do perfil
        const profileColor = localStorage.getItem('userNeonColor') || '#00f2ff';
        document.documentElement.style.setProperty('--user-color', profileColor);

        const viewport = document.getElementById('apartment-viewport');
        const balanceDisplay = document.getElementById('balance');

        function updateBalance() {
            balanceDisplay.innerText = `${userNP.toLocaleString('pt-BR')} NP`;
        }

        // Função para comprar móveis
        window.buyFurniture = (type) => {
            const costs = { rect: 500, cube: 300, circle: 700 };
            if (userNP < costs[type]) return alert("Saldo NP insuficiente!");

            userNP -= costs[type];
            updateBalance();

            const el = document.createElement('div');
            el.className = 'furniture';
            el.dataset.type = type;
            
            // Estilos baseados no tipo
            if(type === 'rect') { el.style.width = '120px'; el.style.height = '40px'; }
            if(type === 'cube') { el.style.width = '60px'; el.style.height = '60px'; }
            if(type === 'circle') { el.style.width = '80px'; el.style.height = '80px'; el.style.borderRadius = '50%'; }

            // Posição aleatória inicial
            el.style.left = (Math.random() * 60 + 20) + '%';
            el.style.top = (Math.random() * 60 + 20) + '%';
            el.style.background = 'rgba(255,255,255,0.05)';
            el.style.boxShadow = `0 0 10px rgba(255,255,255,0.1)`;

            el.onclick = (e) => {
                e.stopPropagation();
                selectFurniture(el);
            };

            viewport.appendChild(el);
            makeDraggable(el);
        };

        function selectFurniture(el) {
            if(selectedElement) selectedElement.style.borderColor = 'rgba(255,255,255,0.1)';
            selectedElement = el;
            selectedElement.style.borderColor = profileColor;
            document.getElementById('edit-menu').style.display = 'block';
        }

        window.updateFurnitureColor = (color) => {
            if(!selectedElement) return;
            if(userNP < 100) return alert("NP insuficiente para pintar!");
            
            userNP -= 100;
            updateBalance();
            selectedElement.style.background = color + '33'; // 20% opacidade
            selectedElement.style.borderColor = color;
            selectedElement.style.boxShadow = `0 0 15px ${color}`;
        };

        window.removeFurniture = () => {
            if(selectedElement) {
                selectedElement.remove();
                selectedElement = null;
                document.getElementById('edit-menu').style.display = 'none';
            }
        };

        // Função simples de arrastar
        function makeDraggable(el) {
            let isDragging = false;
            el.onmousedown = (e) => { isDragging = true; };
            window.onmousemove = (e) => {
                if(isDragging && selectedElement) {
                    selectedElement.style.left = (e.clientX - 30) + 'px';
                    selectedElement.style.top = (e.clientY - 30) + 'px';
                }
            };
            window.onmouseup = () => { isDragging = false; };
        }

        // Salvar no Firebase
        window.saveApartment = async () => {
            const items = [];
            document.querySelectorAll('.furniture').forEach(f => {
                items.push({
                    type: f.dataset.type,
                    left: f.style.left,
                    top: f.style.top,
                    color: f.style.borderColor
                });
            });

            try {
                const userRef = doc(db, "usuarios", userId);
                await updateDoc(userRef, { 
                    apartamento: items,
                    nexusPoints: userNP 
                });
                alert("Apartamento sincronizado no Nexus!");
            } catch (e) { console.error(e); }
        };

        updateBalance();
    </script>
    <script type="module" src="nexus-overlay.js"></script>
</body>
</html>
