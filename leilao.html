<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8",
        authDomain: "minharifadigital.firebaseapp.com",
        projectId: "minharifadigital",
        appId: "1:59630725905:web:396c8cfca385dc3d957ab0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let user;
    let userBids = 0;
    let nomeUsuario = "";
    let leilaoEncerrado = false;

    // 1. Monitorar Usuário
    onAuthStateChanged(auth, (u) => {
        if (u) {
            user = u;
            onSnapshot(doc(db, "usuarios", u.uid), (snap) => {
                const data = snap.data();
                if (data) {
                    nomeUsuario = data.nome;
                    userBids = data.bids || 0;
                    document.getElementById('u-bids').innerText = userBids;
                    document.getElementById('u-saldo').innerText = `R$ ${(data.saldo || 0).toFixed(2)}`;
                }
            });
        }
    });

    // 2. Sincronização em Tempo Real do Leilão
    const leilaoRef = doc(db, "leiloes", "ativo");
    
    onSnapshot(leilaoRef, (snap) => {
        const data = snap.data();
        if (!data) return;

        // Atualiza Preço e Ganhador atual
        document.getElementById('current-price').innerText = data.preco.toFixed(2);
        document.getElementById('bidder').innerText = `ÚLTIMO LANCE: ${data.ultimo_licitante.toUpperCase()}`;
        
        // Lógica do Cronômetro Baseado no Servidor
        iniciarCronometro(data.termina_em?.toDate());
    });

    let timerInterval;
    function iniciarCronometro(dataFinal) {
        if (!dataFinal) return;
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const agora = new Date().getTime();
            const distancia = dataFinal.getTime() - agora;
            
            if (distancia <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "ENCERRADO";
                document.getElementById('timer').style.color = "#ff0000";
                leilaoEncerrado = true;
            } else {
                const segundos = Math.floor((distancia % (1000 * 60)) / 1000);
                document.getElementById('timer').innerText = `00:${segundos.toString().padStart(2, '0')}`;
                leilaoEncerrado = false;
                
                // Alerta visual de 5 segundos
                document.getElementById('timer').style.color = segundos <= 5 ? "#ff0000" : "#fff";
            }
        }, 1000);
    }

    // 3. Função de Dar Lance
    window.darLance = async () => {
        if (leilaoEncerrado) return alert("Leilão já encerrado!");
        
        const custoLanceReal = 0.10; // Valor descontado do saldo caso o usuário esteja sem Bids
        let metodoPagamento = "";

        // LÓGICA DE CONEXÃO: Prioriza Bids, se não houver, usa Saldo
        if (userBids >= 1) {
            metodoPagamento = "bids";
        } else {
            // Pega o saldo atual do elemento da tela (convertendo string para número)
            const saldoAtual = parseFloat(document.getElementById('u-saldo').innerText.replace('R$ ', ''));
            
            if (saldoAtual >= custoLanceReal) {
                metodoPagamento = "saldo";
            } else {
                alert("⚠️ SALDO INSUFICIENTE!\n\nVocê não possui Bids nem saldo em dinheiro para continuar lançando.");
                return;
            }
        }

        try {
            const novaDataFinal = new Date(new Date().getTime() + 15000);
            const userRef = doc(db, "usuarios", user.uid);

            // 1. ATUALIZA A ARENA PARA TODOS
            await updateDoc(leilaoRef, {
                preco: increment(0.01),
                ultimo_licitante: nomeUsuario,
                termina_em: novaDataFinal
            });

            // 2. PROCESSA O DESCONTO CONECTADO
            if (metodoPagamento === "bids") {
                await updateDoc(userRef, { bids: increment(-1) });
                console.log("Lance pago com: 1 Bid");
            } else {
                await updateDoc(userRef, { saldo: increment(-custoLanceReal) });
                console.log(`Lance pago com: R$ ${custoLanceReal}`);
                alert(`Você usou R$ ${custoLanceReal} do seu saldo pois seus Bids acabaram!`);
            }

        } catch (e) {
            console.error("Erro na transação:", e);
        }
    };
</script>
