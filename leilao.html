<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mundo dos Lances v5.3.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --orange: #ff7b00; --neon: #00f2ff; --green: #00ff88; }
        body { background: #000; color: #fff; font-family: 'Rajdhani', sans-serif; margin: 0; overflow-x: hidden; }
        
        .header { height: 60px; display: flex; align-items: center; justify-content: center; background: #000; border-bottom: 1px solid #111; font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 2px; position: relative; }
        .btn-back { background:none; border:none; color:var(--orange); font-size:1.2rem; position:absolute; left:15px; cursor: pointer; }

        .container { padding: 20px; max-width: 500px; margin: 0 auto; }
        
        .bids-status { background: #050505; border: 1px solid #111; padding: 15px; border-radius: 15px; display: flex; justify-content: space-around; margin-bottom: 20px; }
        .status-item span { display: block; font-family: 'Orbitron'; font-size: 0.5rem; color: #444; margin-bottom: 5px; }
        .status-item b { color: #fff; font-size: 1rem; font-family: 'Orbitron'; }

        .auction-card { background: linear-gradient(180deg, #0a0a0a 0%, #000 100%); border: 1px solid #1a1a1a; border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .timer-display { font-family: 'Orbitron'; font-size: 2.8rem; color: #fff; text-shadow: 0 0 15px var(--orange); margin: 20px 0; }
        .current-bidder { background: rgba(255, 123, 0, 0.1); color: var(--orange); padding: 8px 15px; border-radius: 20px; font-size: 0.7rem; font-family: 'Orbitron'; display: inline-block; margin-bottom: 20px; border: 1px solid rgba(255,123,0,0.2); }
        .bid-price { font-size: 2rem; color: var(--green); font-family: 'Orbitron'; font-weight: bold; margin: 10px 0; }

        .btn-bid { background: var(--orange); color: #000; border: none; width: 100%; padding: 20px; border-radius: 15px; font-family: 'Orbitron'; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 15px rgba(255, 123, 0, 0.3); transition: 0.2s; }
        .btn-bid:active { transform: scale(0.95); background: #fff; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-back" onclick="window.location.href='index.html'">⬅</button>
        ARENA DE LANCES
    </div>

    <div class="container">
        <div class="bids-status">
            <div class="status-item">
                <span>SEUS BIDS</span>
                <b id="u-bids">0</b>
            </div>
            <div class="status-item">
                <span>SALDO CARTEIRA</span>
                <b id="u-saldo">R$ 0.00</b>
            </div>
        </div>

        <div class="auction-card">
            <div style="font-family:'Orbitron'; color:#444; font-size:0.6rem; letter-spacing:2px;">PRÊMIO EM DISPUTA</div>
            <div style="font-size: 1.5rem; color:#fff; font-weight:bold; margin: 10px 0; font-family: 'Rajdhani';">PIX DE R$ 200,00</div>
            
            <div class="timer-display" id="timer">00:15</div>
            
            <div class="current-bidder" id="bidder">AGUARDANDO LANCE...</div>
            
            <div style="font-family:'Orbitron'; font-size:0.55rem; color:#444;">VALOR ATUAL</div>
            <div class="bid-price">R$ <span id="current-price">0.00</span></div>

            <button class="btn-bid" id="btn-main" onclick="darLance()">
                DAR LANCE
            </button>
            
            <p style="font-size:0.55rem; color:#333; margin-top:15px; font-family:'Orbitron'; line-height: 1.4;">
                Custo: 1 Bid ou R$ 0,10 (se não houver bids).<br>
                Cada lance adiciona +10s ao cronômetro.
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYO5RWaJy5y7r7jvzFk3wq-ByqM_dWWO8",
            authDomain: "minharifadigital.firebaseapp.com",
            projectId: "minharifadigital",
            appId: "1:59630725905:web:396c8cfca385dc3d957ab0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let user;
        let userBids = 0;
        let saldoReal = 0;
        let nomeUsuario = "";
        let leilaoEncerrado = false;

        // Monitorar Usuário
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                onSnapshot(doc(db, "usuarios", u.uid), (snap) => {
                    const data = snap.data();
                    if (data) {
                        nomeUsuario = data.nome;
                        userBids = data.bids || 0;
                        saldoReal = data.saldo || 0;
                        document.getElementById('u-bids').innerText = userBids;
                        document.getElementById('u-saldo').innerText = `R$ ${saldoReal.toFixed(2)}`;
                    }
                });
            } else { window.location.href = 'login.html'; }
        });

        // Sincronização do Leilão
        const leilaoRef = doc(db, "leiloes", "ativo");
        onSnapshot(leilaoRef, (snap) => {
            const data = snap.data();
            if (data) {
                document.getElementById('current-price').innerText = data.preco.toFixed(2);
                document.getElementById('bidder').innerText = `ÚLTIMO LANCE: ${data.ultimo_licitante.toUpperCase()}`;
                
                // Lógica simples de tempo para teste (Ideal ser via Timestamp como antes)
                iniciarTimer(15);
            }
        });

        let countdown;
        function iniciarTimer(seg) {
            clearInterval(countdown);
            let tempo = seg;
            countdown = setInterval(() => {
                tempo--;
                document.getElementById('timer').innerText = `00:${tempo.toString().padStart(2,'0')}`;
                if(tempo <= 0) {
                    clearInterval(countdown);
                    document.getElementById('timer').innerText = "ENCERRADO";
                    leilaoEncerrado = true;
                }
            }, 1000);
        }

        window.darLance = async () => {
            if (leilaoEncerrado) return;

            let metodo = "";
            if (userBids >= 1) {
                metodo = "bids";
            } else if (saldoReal >= 0.10) {
                metodo = "saldo";
            } else {
                alert("Sem Bids ou Saldo!");
                return;
            }

            try {
                // Atualiza Leilão
                await updateDoc(leilaoRef, {
                    preco: increment(0.01),
                    ultimo_licitante: nomeUsuario
                });

                // Desconto Conectado
                const userRef = doc(db, "usuarios", user.uid);
                if (metodo === "bids") {
                    await updateDoc(userRef, { bids: increment(-1) });
                } else {
                    await updateDoc(userRef, { saldo: increment(-0.10) });
                }
            } catch (e) { console.error(e); }
        };
    </script>
</body>
</html>
